name: Build Psych Online Mobile + Release
on:
  workflow_dispatch:
    inputs:
      name:
        description: "Release name (e.g. many fixes or daily update)"
        required: true
      tag_name:
        description: "Release tag (e.g. v0.13.3 or bugfix)"
        required: true
      prerelease:
        description: "Is this a prerelease?"
        required: true
        type: boolean
      custom_message:
        description: "Optional pre-changelog message"
        required: false

permissions:
  contents: write
  discussions: write

env:
  PROJECT_NAME: PsychOnline
  TAG_NAME: ${{ github.event.inputs.tag_name }}
  NAME: ${{ github.event.inputs.name }}

jobs:
  ensure-tag:
    name: Create Tag (if needed)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch all tags
        run: git fetch --tags

      - name: Set tag name
        id: tagger
        run: echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git tag ${{ github.event.inputs.tag_name }}
          git push origin ${{ github.event.inputs.tag_name }}

      - name: Prepare pre-changelog message
        id: pre_changelog_message
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Preparing a pre-changelog message..."

          BODY=""

          if [ -n "${{ github.event.inputs.custom_message }}" ]; then
            BODY="${{ github.event.inputs.custom_message }}\n${BODY}"
          fi

          {
            echo "body<<EOF"
            echo -e "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo -e "Final pre-changelog message:\n\n$BODY"

  build:
    name: ${{ matrix.name }}
    needs: ensure-tag
    strategy:
      matrix:
        include:
          - name: Android
            os: macos-15
            buildArgs: "android -final -D officialBuild"
            artifactName: androidBuild
            artifactPath: "export/release/android/bin/app/build/outputs/apk/release/*.apk"
          - name: iOS
            os: macos-15
            buildArgs: "ios -final -nosign -D officialBuild"
            artifactName: iOSBuild
            artifactPath: "export/release/ios/build/Release-iphoneos/*.ipa"
    uses: ./.github/workflows/build.yml
    with:
        name: ${{ matrix.name }}
        os: ${{ matrix.os }}
        buildArgs: ${{ matrix.buildArgs }}
        assetType: ${{ matrix.assetType }}
        artifactName: ${{ matrix.artifactName }}
        artifactPath: ${{ matrix.artifactPath }}

  Releaser:
    needs: [build]
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Download Android Build
        uses: actions/download-artifact@main
        with:
          name: androidBuild
          path: /home/runner

      - name: Move Android File
        run: mv /home/runner/${{ env.PROJECT_NAME }}-release.apk /home/runner/${{ env.PROJECT_NAME }}-Android.apk

      - name: Download iOS Build
        uses: actions/download-artifact@main
        with:
          name: iOSBuild
          path: ${{ github.workspace }}

      - name: Move iOS File
        run: mv ${{ github.workspace }}/${{ env.PROJECT_NAME }}.ipa /home/runner/${{ env.PROJECT_NAME }}-iOS.ipa

      - name: Publish The Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.NAME }}
          tag_name: ${{ env.TAG_NAME }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            /home/runner/*.apk
            /home/runner/*.ipa
            /home/runner/*.tar
            /home/runner/*.zip